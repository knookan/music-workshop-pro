{"version":3,"file":"greedy-fas.js","sources":["../../../../node_modules/dagre/lib/greedy-fas.js"],"sourcesContent":["var _ = require(\"./lodash\");\nvar Graph = require(\"./graphlib\").Graph;\nvar List = require(\"./data/list\");\n\n/*\n * A greedy heuristic for finding a feedback arc set for a graph. A feedback\n * arc set is a set of edges that can be removed to make a graph acyclic.\n * The algorithm comes from: P. Eades, X. Lin, and W. F. Smyth, \"A fast and\n * effective heuristic for the feedback arc set problem.\" This implementation\n * adjusts that from the paper to allow for weighted edges.\n */\nmodule.exports = greedyFAS;\n\nvar DEFAULT_WEIGHT_FN = _.constant(1);\n\nfunction greedyFAS(g, weightFn) {\n  if (g.nodeCount() <= 1) {\n    return [];\n  }\n  var state = buildState(g, weightFn || DEFAULT_WEIGHT_FN);\n  var results = doGreedyFAS(state.graph, state.buckets, state.zeroIdx);\n\n  // Expand multi-edges\n  return _.flatten(_.map(results, function(e) {\n    return g.outEdges(e.v, e.w);\n  }), true);\n}\n\nfunction doGreedyFAS(g, buckets, zeroIdx) {\n  var results = [];\n  var sources = buckets[buckets.length - 1];\n  var sinks = buckets[0];\n\n  var entry;\n  while (g.nodeCount()) {\n    while ((entry = sinks.dequeue()))   { removeNode(g, buckets, zeroIdx, entry); }\n    while ((entry = sources.dequeue())) { removeNode(g, buckets, zeroIdx, entry); }\n    if (g.nodeCount()) {\n      for (var i = buckets.length - 2; i > 0; --i) {\n        entry = buckets[i].dequeue();\n        if (entry) {\n          results = results.concat(removeNode(g, buckets, zeroIdx, entry, true));\n          break;\n        }\n      }\n    }\n  }\n\n  return results;\n}\n\nfunction removeNode(g, buckets, zeroIdx, entry, collectPredecessors) {\n  var results = collectPredecessors ? [] : undefined;\n\n  _.forEach(g.inEdges(entry.v), function(edge) {\n    var weight = g.edge(edge);\n    var uEntry = g.node(edge.v);\n\n    if (collectPredecessors) {\n      results.push({ v: edge.v, w: edge.w });\n    }\n\n    uEntry.out -= weight;\n    assignBucket(buckets, zeroIdx, uEntry);\n  });\n\n  _.forEach(g.outEdges(entry.v), function(edge) {\n    var weight = g.edge(edge);\n    var w = edge.w;\n    var wEntry = g.node(w);\n    wEntry[\"in\"] -= weight;\n    assignBucket(buckets, zeroIdx, wEntry);\n  });\n\n  g.removeNode(entry.v);\n\n  return results;\n}\n\nfunction buildState(g, weightFn) {\n  var fasGraph = new Graph();\n  var maxIn = 0;\n  var maxOut = 0;\n\n  _.forEach(g.nodes(), function(v) {\n    fasGraph.setNode(v, { v: v, \"in\": 0, out: 0 });\n  });\n\n  // Aggregate weights on nodes, but also sum the weights across multi-edges\n  // into a single edge for the fasGraph.\n  _.forEach(g.edges(), function(e) {\n    var prevWeight = fasGraph.edge(e.v, e.w) || 0;\n    var weight = weightFn(e);\n    var edgeWeight = prevWeight + weight;\n    fasGraph.setEdge(e.v, e.w, edgeWeight);\n    maxOut = Math.max(maxOut, fasGraph.node(e.v).out += weight);\n    maxIn  = Math.max(maxIn,  fasGraph.node(e.w)[\"in\"]  += weight);\n  });\n\n  var buckets = _.range(maxOut + maxIn + 3).map(function() { return new List(); });\n  var zeroIdx = maxIn + 1;\n\n  _.forEach(fasGraph.nodes(), function(v) {\n    assignBucket(buckets, zeroIdx, fasGraph.node(v));\n  });\n\n  return { graph: fasGraph, buckets: buckets, zeroIdx: zeroIdx };\n}\n\nfunction assignBucket(buckets, zeroIdx, entry) {\n  if (!entry.out) {\n    buckets[0].enqueue(entry);\n  } else if (!entry[\"in\"]) {\n    buckets[buckets.length - 1].enqueue(entry);\n  } else {\n    buckets[entry.out - entry[\"in\"] + zeroIdx].enqueue(entry);\n  }\n}\n"],"names":["require$$0","require$$1","require$$2"],"mappings":"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","x_google_ignoreList":[0]}